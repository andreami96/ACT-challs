#include <stdio.h>
#include <string.h>
#include <sys/ptrace.h>
#include <sys/mman.h>

#define PWD_LEN 13
#define FLAG_LEN 31
#define CODE_LEN 179

char flag_key[FLAG_LEN] = {0x0d,0x67,0xf1,0xc6,0x98,0xd2,0xe5,0x2d,0xb4,0x3b,0xb6,0xf2,0x2c,0xb2,0xe0,0x48,0x4c,0xe3,0xad,0x3c,0xf2,0x88,0x00,0x07,0xf4,0x8c,0x63,0x54,0xd5,0x8e,0xe3};
char flag_enc[FLAG_LEN + 18] = {0xd5,0x96,0x4b,0x23,0x31,0xb4,0x3e,0x6c,0x34,0xb2,  0x6b,0x0b,0x90,0xa1,0xe3,0xbc,0x8c,0x4e,0xd1,0x64,0xda,0x9b,0x58,0xc6,0x8c,0x2d,0x13,0x91,0xc8,0x4a,0xad,0xe5,0x79,0x58,0x92,0xfe,0x0a,0x31,0xbb,0xea,0x9e,  0x29,0xf5,0x9d,0xb2,0x66,0x53,0x8a,0x0d};

char pwd_iv[PWD_LEN] = {0x95,0xad,0xd4,0xfe,0x77,0x5f,0x6f,0xae,0xea,0x78,0x82,0x60,0x47};
char k[PWD_LEN] = {0x7e,0x49,0x7f,0xc0,0x1c,0xe0,0xd2,0xf1,0x4c,0x4d,0x4f,0x74,0xf0};

char packed[CODE_LEN] = {0x32,0x79,0xe4,0x88,0x7b,0xe5,0x80,0x14,0x2f,0xd6,0x0d,0x84,0xf1,0x62,0x87,0x6d,0x6d,0x33,0xe3,0xac,0x41,0x43,0xe6,0x70,0x6c,0x7a,0x67,0x8b,0x6c,0x6d,0x33,0x66,0xd2,0x34,0x67,0x5f,0x70,0xd3,0x7a,0x67,0x31,0x6d,0xd5,0x33,0x66,0x6c,0x34,0x8f,0x33,0x83,0xb3,0x85,0xee,0x34,0xe3,0x6d,0x33,0x66,0xe7,0x31,0xef,0x5f,0x70,0x6c,0xf9,0x9f,0xce,0x18,0x63,0x7b,0xa1,0xab,0xac,0x76,0x3f,0x70,0x84,0x45,0x94,0xee,0x92,0x86,0x6e,0x2e,0xe7,0x71,0x8f,0x17,0xf3,0xac,0x77,0x68,0x87,0x6d,0x51,0x12,0x13,0x22,0xf3,0x22,0xa3,0x70,0x6c,0x7a,0x67,0xda,0x58,0xe6,0x76,0x9a,0xef,0xf4,0x6d,0x17,0x13,0xbc,0x32,0xa0,0xf1,0xed,0x7d,0x53,0x66,0x63,0x82,0x6b,0x5d,0xfb,0x29,0x86,0x2f,0x52,0xbd,0x25,0xf4,0xa6,0x0c,0x24,0x07,0x5f,0x7f,0xda,0x7e,0x65,0x00,0xa5,0x62,0x8d,0xa6,0xe5,0xf3,0x8f,0xbb,0x82,0xb3,0x85,0xe4,0x74,0x91,0x6c,0xb0,0x1b,0x90,0x2a,0x19,0x9a,0xcf,0x66,0x7a,0x67,0x31,0x85,0xbd,0xc1,0xb9,0x93,0xa4,0xae,0x9c};
char msg[9] = "Get out!";
int isPtraced;

void unpack(char* pwd) {

	int i;
	for(i = 0; i < CODE_LEN; i++)
		packed[i] = (pwd[i % PWD_LEN] ^ (int)packed[i]);

}

int main(int argc, char* argv[]) {

	int isCorrect = 1;

	if (argc != 1) {
		putchar('*');
		puts("Usage: ./littlerev PASSWORD");
		return 1;
	}

	// check if process is being debugged
	isPtraced = ptrace(PTRACE_TRACEME, 0, 1, 0);
	if (isPtraced == -1) {
		puts("Bruh don't even try");
		return 1;
	} else {

		if (argv[1][0] != (0x31 ^ (( (int)pwd_iv[0] * (int)k[0] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][1] != (0x64 ^ (( (int)pwd_iv[1] * (int)k[1] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][2] != (0x41 ^ (( (int)pwd_iv[2] * (int)k[2] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][3] != (0xed ^ (( (int)pwd_iv[3] * (int)k[3] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][4] != (0x37 ^ (( (int)pwd_iv[4] * (int)k[4] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][5] != (0x46 ^ (( (int)pwd_iv[5] * (int)k[5] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][6] != (0x62 ^ (( (int)pwd_iv[6] * (int)k[6] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][7] != (0xfa ^ (( (int)pwd_iv[7] * (int)k[7] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][8] != (0x1f ^ (( (int)pwd_iv[8] * (int)k[8] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][9] != (0x47 ^ (( (int)pwd_iv[9] * (int)k[9] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][10] != (0x6e ^ (( (int)pwd_iv[10] * (int)k[10] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][11] != (0xec ^ (( (int)pwd_iv[11] * (int)k[11] ) & 0xff))) {isCorrect = 0;}
		if (argv[1][12] != (0xea ^ (( (int)pwd_iv[12] * (int)k[12] ) & 0xff))) {isCorrect = 0;}

		if (isCorrect) {
			unpack(argv[1]);
			(*(void(*)(char*))packed)(argv[1]);		// call unpacked function
		} else
			puts("Nope");
	}

}





















